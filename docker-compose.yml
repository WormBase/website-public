version: "3.7"
services:
  website:
    container_name: "website"
    image: "357210185381.dkr.ecr.us-east-1.amazonaws.com/wormbase/website:WSXXX"
    init: true
#    links:
#      - "upstream-proxy"
#      - "nginx-proxy"
    depends_on:
      - "nginx-proxy"       
    ports:
      - "5001:5000"
      - "9001:9001"
    volumes:
      - "awseb-logs-website:/usr/local/wormbase/website/logs"
      - "/usr/local/wormbase/website-shared-files:/usr/local/wormbase/website-shared-files"
      - "/usr/local/wormbase/databases:/usr/local/wormbase/databases"
      - "/usr/local/wormbase/services:/usr/local/wormbase/services"
    environment:
      - ACEDB_PORT=2005
      - APP=${CATALYST_APP}
      - ACEDB_HOST=${ACEDB_HOST}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - JWT_SECRET='This is a test'
      - CATALYST_APP=production
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
    deploy:
      resources:
        reservations:
          memory: 8000M
  nginx-proxy:
#    links: 
#       - "website"
    image: nginx:1.13.7
    ports:
      - "80:80"
    volumes:
      - "awseb-logs-nginx-proxy:/var/log/nginx"
      - "./proxy/conf.d:/etc/nginx/conf.d"
#      - "/var/app/current/proxy/conf.d:/etc/nginx/conf.d"
#  upstream-proxy:
#    image: nginx:1.13.7
#    ports:
#      - "3001:3001"
#    volumes:
#      - "awseb-logs-upstream-proxy:/var/log/nginx"
#      - "/var/app/current/proxy/upstream-proxy/conf.d:/etc/nginx/conf.d"
#    deploy:
#      resources:
#        reservations:
#          memory: 512M
volumes:
  awseb-logs-upstream-proxy:
  awseb-logs-website:
  awseb-logs-nginx-proxy:
